// Generated by CoffeeScript 1.7.1
var db, deleteFiles, downloader, fs, log, multiparty;

fs = require("fs");

multiparty = require('multiparty');

log = require('printit')({
  date: true,
  prefix: 'attachment'
});

db = require('../helpers/db_connect_helper').db_connect();

deleteFiles = require('../helpers/utils').deleteFiles;

downloader = require('../lib/downloader');

module.exports.add = function(req, res, next) {
  var fields, form, nofile;
  form = new multiparty.Form();
  form.parse(req);
  nofile = true;
  fields = {};
  form.on('part', function(part) {
    var fileData, name, stream;
    if (part.filename == null) {
      fields[part.name] = '';
      part.on('data', function(buffer) {
        return fields[part.name] = buffer.toString();
      });
      return part.resume();
    } else {
      nofile = false;
      if (fields.name != null) {
        name = fields.name;
      } else {
        name = part.filename;
      }
      fileData = {
        name: name,
        "content-type": part.headers['content-type']
      };
      log.info("attachment " + name + " ready for storage");
      stream = db.saveAttachment(req.doc, fileData, function(err) {
        if (err) {
          console.log("[Attachment] err: " + JSON.stringify(err));
          return form.emit('error', new Error(err.error));
        } else {
          log.info("Attachment " + name + " saved to Couch.");
          res.send(201, {
            success: true
          });
          return next();
        }
      });
      return part.pipe(stream);
    }
  });
  form.on('progress', function(bytesReceived, bytesExpected) {});
  form.on('error', function(err) {
    return next(err);
  });
  return form.on('close', function() {
    var err;
    if (nofile) {
      err = new Error('no file sent');
      err.status = 400;
      return next(err);
    }
  });
};

module.exports.get = function(req, res, next) {
  var id, name;
  name = req.params.name;
  id = req.doc.id;
  return downloader.download(id, name, function(err, stream) {
    var length, type;
    if ((err != null) && err.error === "not_found") {
      err = new Error("not found");
      err.status = 404;
      return next(err);
    } else if (err) {
      return next(new Error(err.error));
    } else {
      if (req.headers['range'] != null) {
        stream.setHeader('range', req.headers['range']);
      }
      length = req.doc._attachments[name].length;
      type = req.doc._attachments[name]['content-type'];
      res.setHeader('Content-Length', length);
      res.setHeader('Content-Type', type);
      return stream.pipe(res);
    }
  });
};

module.exports.remove = function(req, res, next) {
  var name;
  name = req.params.name;
  return db.removeAttachment(req.doc, name, function(err) {
    next();
    if ((err != null) && (err.error = "not_found")) {
      err = new Error("not found");
      err.status = 404;
      return next(err);
    } else if (err != null) {
      console.log("[Attachment] err: " + JSON.stringify(err));
      return next(err);
    } else {
      return res.send(204, {
        success: true
      });
    }
  });
};
